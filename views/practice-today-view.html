<div class="flex items-center justify-between mb-6 bg-white border border-gray-200 rounded-lg shadow-sm p-4">
    <div>
        <h2 class="text-2xl font-bold text-gray-900">Practice Today</h2>
        <p class="text-sm text-gray-500 mt-1" x-text="'Your practice session for ' + new Date(practiceDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })"></p>
    </div>
    <div class="flex items-center gap-2">
        <button @click="prevPracticeDay()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">&lt;</button>
        <input type="date" x-model="practiceDate" @change="loadPracticeSession(practiceDate)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 p-2">
        <button @click="nextPracticeDay()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">&gt;</button>
    </div>
</div>

<div class="flex justify-end gap-2 mb-4">
    <button @click="expandAllPracticeGoals()" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">Expand All</button>
    <button @click="collapseAllPracticeGoals()" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">Collapse All</button>
</div>

<div x-show="isPracticeLoading" class="text-center py-8 text-gray-500">Loading session...</div>

<div x-show="!isPracticeLoading">
    <!-- Empty State -->
    <template x-if="!practiceGoals || practiceGoals.length === 0">
        <div class="text-center py-12 text-gray-500 text-lg">
            <p class="mb-4">No goals in this practice session yet.</p>
            <p class="text-sm">
                <template x-if="isToday(practiceDate)">
                    <span>Go to the Topics tab to add goals to today's session.</span>
                </template>
                <template x-if="!isToday(practiceDate)">
                    <span>This date has no practice session.</span>
                </template>
            </p>
        </div>
    </template>

    <!-- Session Goals -->
    <template x-if="practiceGoals && practiceGoals.length > 0">
        <div>
            <template x-for="goal in practiceGoals" :key="goal.id">
                <details class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 mb-4" :open="(uiState.practiceGoalStates && uiState.practiceGoalStates[goal.id]) ?? false" @toggle="if (!uiState.practiceGoalStates) uiState.practiceGoalStates = {}; uiState.practiceGoalStates[goal.id] = $event.target.open">
                    <summary class="cursor-pointer flex items-center justify-between mb-4 list-none">
                        <div>
                            <div class="text-lg font-semibold text-gray-900 mb-1">
                                <strong><span x-text="goal.goal_number"></span>:</strong>
                                <span x-text="goal.description + ' (' + (goal.logs?.filter(log => log.date === practiceDate).length || 0) + ')'"></span>
                            </div>
                            <div class="text-sm text-gray-500" x-text="goal.topic_title"></div>
                        </div>
                        <button
                            class="text-red-600 hover:text-red-800 text-xl font-bold px-2"
                            @click.prevent="if (confirm('Remove this goal from the session?')) removeGoalFromPracticeSession(goal.id)"
                            title="Remove from session"
                        >×</button>
                    </summary>

                    <!-- Content and Repertoire Inline -->
                    <div class="mb-4 flex flex-wrap items-center gap-4">
                        <div class="flex items-center gap-2">
                            <strong class="text-sm text-gray-700">Content:</strong>

                            <div class="relative" x-data="{ isOpen: false, searchTerm: '', searchResults: [] }">
                                <button class="text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded px-2 py-0.5" @click.prevent="isOpen = !isOpen">+</button>

                                <div class="absolute z-50 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 p-4 w-80" x-show="isOpen" @click.outside="isOpen = false" x-cloak>
                                    <h5 class="text-sm font-semibold text-gray-900 mb-2">Add Content</h5>
                                    <input
                                        type="text"
                                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 mb-2"
                                        placeholder="Search library..."
                                        x-model="searchTerm"
                                        @input.debounce.300ms="dataLayer.searchContent(searchTerm).then(data => searchResults = data)"
                                    >
                                    <ul class="max-h-40 overflow-y-auto" x-show="searchTerm.length > 1">
                                        <template
                                            x-for="result in searchResults.filter(r => (!goal.content || !goal.content.some(linked => linked.id === r.id)))">
                                            <li class="text-sm text-gray-900 py-2 px-2 hover:bg-gray-100 rounded cursor-pointer" @click="
                                                dataLayer.linkContentToGoal(goal.id, result.id);
                                                if (!goal.content) {
                                                    goal.content = [];
                                                }
                                                goal.content.push(result);
                                                searchTerm = '';
                                                searchResults = [];
                                                isOpen = false;
                                            ">
                                                <span x-text="result.title"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>

                            <template x-if="goal.content && goal.content.length > 0">
                                <template x-for="item in goal.content" :key="item.id">
                                    <span class="inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">
                                        <span
                                            class="cursor-pointer hover:underline"
                                            @click="
                                                if (item.type === 'YouTube') {
                                                    const videoId = dataLayer.getYoutubeVideoId(item.url);
                                                    if (videoId) {
                                                        youTubeVideoId = videoId;
                                                        isYouTubeModalOpen = true;
                                                    }
                                                } else {
                                                    window.open(item.url, '_blank');
                                                }
                                            "
                                            x-text="item.title"
                                        ></span>
                                        <button
                                            class="ml-1 text-blue-600 hover:text-blue-800 font-bold"
                                            @click="
                                                dataLayer.unlinkContentFromGoal(goal.id, item.id);
                                                goal.content = goal.content.filter(c => c.id !== item.id);
                                            "
                                        >×</button>
                                    </span>
                                </template>
                            </template>
                        </div>

                        <div class="flex items-center gap-2">
                            <strong class="text-sm text-gray-700">Tune:</strong>

                            <div class="relative" x-data="{ isOpen: false, searchTerm: '', searchResults: [] }">
                                <template x-if="goal.repertoire">
                                    <span class="inline-flex items-center bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">
                                        <span x-text="goal.repertoire.title"></span>
                                        <button
                                            class="ml-1 text-green-600 hover:text-green-800 font-bold"
                                            @click.prevent="
                                                dataLayer.unlinkRepertoireFromGoal(goal.id);
                                                goal.repertoire = null;
                                            "
                                        >×</button>
                                    </span>
                                </template>

                                <template x-if="!goal.repertoire">
                                    <button class="text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded px-2 py-0.5" @click.prevent="isOpen = !isOpen">+</button>
                                </template>

                                <div class="absolute z-50 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 p-4 w-80" x-show="isOpen" @click.outside="isOpen = false" x-cloak>
                                    <h5 class="text-sm font-semibold text-gray-900 mb-2">Add Tune</h5>
                                    <input
                                        type="text"
                                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 mb-2"
                                        placeholder="Search repertoire..."
                                        x-model="searchTerm"
                                        @input.debounce.300ms="dataLayer.searchRepertoire(searchTerm).then(data => searchResults = data)"
                                    >
                                    <ul class="max-h-40 overflow-y-auto" x-show="searchTerm.length > 1">
                                        <template x-for="result in searchResults" :key="result.id">
                                            <li
                                                class="text-sm text-gray-900 py-2 px-2 hover:bg-gray-100 rounded cursor-pointer"
                                                @click="
                                                    dataLayer.linkRepertoireToGoal(goal.id, result.id);
                                                    goal.repertoire = result;
                                                    goal.repertoire_id = result.id;
                                                    isOpen = false;
                                                    searchTerm = '';
                                                    searchResults = [];
                                                "
                                            >
                                                <span x-text="result.title"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Goal Actions -->
                    <div class="mb-4">
                        <button
                            class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2"
                            @click="isAddLogModalOpen = true; loggingForGoal = goal"
                        >Add Log</button>
                    </div>

                    <!-- Logs -->
                    <template x-if="goal.logs && goal.logs.length > 0">
                        <div x-data="{
                            get filteredLogs() {
                                if (goal.showAllLogs) {
                                    return goal.logs;
                                }
                                return goal.logs.filter(log => log.date === practiceDate);
                            }
                        }">
                            <ul class="space-y-2">
                                <template x-for="log in filteredLogs" :key="log.id">
                                    <li class="p-3 bg-gray-50 rounded-lg">
                                        <div class="text-sm text-gray-700 mb-2">
                                            <span class="text-xs text-gray-500 font-medium" x-text="new Date(log.date).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>:
                                            <span x-html="dataLayer.linkify(log.entry)"></span>
                                        </div>

                                        <div class="flex items-center gap-2">
                                            <div class="relative" x-data="{ isOpen: false, searchTerm: '', searchResults: [] }">
                                                <button
                                                    class="text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-full w-5 h-5 flex items-center justify-center"
                                                    @click.prevent="isOpen = !isOpen"
                                                    :title="log.content?.map(c => c.title).join(', ')"
                                                >
                                                    <span x-text="log.content?.length || 0"></span>
                                                </button>

                                                <div class="absolute z-50 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 p-4 w-80" x-show="isOpen" @click.outside="isOpen = false" x-cloak>
                                                    <h5 class="text-sm font-semibold text-gray-900 mb-2">Linked Content</h5>
                                                    <ul class="mb-3 max-h-40 overflow-y-auto">
                                                        <template x-for="item in log.content" :key="item.id">
                                                            <li class="flex items-center justify-between py-2 px-2 hover:bg-gray-50 rounded">
                                                                <span class="text-sm text-blue-600 hover:text-blue-800 cursor-pointer flex-1" x-text="item.title" @click="
                                                                    if (item.type === 'YouTube') {
                                                                        const videoId = dataLayer.getYoutubeVideoId(item.url);
                                                                        if (videoId) {
                                                                            youTubeVideoId = videoId;
                                                                            isYouTubeModalOpen = true;
                                                                        }
                                                                    } else {
                                                                        window.open(item.url, '_blank');
                                                                    }
                                                                    isOpen = false;
                                                                "></span>
                                                                <button class="ml-2 text-red-600 hover:text-red-800 font-bold" @click="
                                                                    dataLayer.unlinkContentFromLog(log.id, item.id);
                                                                    log.content = log.content.filter(c => c.id !== item.id);
                                                                ">×</button>
                                                            </li>
                                                        </template>
                                                        <template x-if="!log.content || log.content.length === 0">
                                                            <li class="text-sm text-gray-500 py-2 px-2">No content linked yet.</li>
                                                        </template>
                                                    </ul>

                                                    <div class="border-t border-gray-200 pt-3">
                                                        <h5 class="text-sm font-semibold text-gray-900 mb-2">Add Content</h5>
                                                        <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 mb-2" placeholder="Search library..." x-model="searchTerm"
                                                            @input.debounce.300ms="dataLayer.searchContent(searchTerm).then(data => searchResults = data)">
                                                        <ul class="max-h-40 overflow-y-auto" x-show="searchTerm.length > 1">
                                                            <template
                                                                x-for="result in searchResults.filter(r => !log.content || !log.content.some(linked => linked.id === r.id))">
                                                                <li class="text-sm text-gray-900 py-2 px-2 hover:bg-gray-100 rounded cursor-pointer" @click="
                                                                    dataLayer.linkContentToLog(log.id, result.id);
                                                                    if (!log.content) log.content = [];
                                                                    log.content.push(result);
                                                                    searchTerm = '';
                                                                    searchResults = [];
                                                                ">
                                                                    <span x-text="result.title"></span>
                                                                </li>
                                                            </template>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Repertoire Popover -->
                                            <div class="relative" x-data="{ isOpen: false, searchTerm: '', searchResults: [] }">
                                                <button
                                                    class="text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-full w-5 h-5 flex items-center justify-center"
                                                    @click.prevent="isOpen = !isOpen"
                                                    :title="log.repertoire?.map(r => r.title + (r.artist ? ' - ' + r.artist : '')).join(', ')"
                                                >
                                                    <span x-text="log.repertoire?.length || 0"></span>
                                                </button>

                                                <div class="absolute z-50 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 p-4 w-80" x-show="isOpen" @click.outside="isOpen = false" x-cloak>
                                                    <h5 class="text-sm font-semibold text-gray-900 mb-2">Linked Tunes</h5>
                                                    <ul class="mb-3 max-h-40 overflow-y-auto">
                                                        <template x-for="rep in log.repertoire" :key="rep.id">
                                                            <li class="flex items-center justify-between py-2 px-2 hover:bg-gray-50 rounded">
                                                                <span class="text-sm text-gray-900 flex-1" x-text="rep.title + (rep.artist ? ' - ' + rep.artist : '')"></span>
                                                                <button class="ml-2 text-red-600 hover:text-red-800 font-bold" @click="
                                                                    (async () => {
                                                                        await dataLayer.unlinkRepertoireFromLog(log.id, rep.id);
                                                                        log.repertoire = log.repertoire.filter(r => r.id !== rep.id);
                                                                        const supabaseClient = dataLayer.getSupabaseClient();
                                                                        await supabaseClient.rpc('update_repertoire_stats', { rep_id: rep.id });
                                                                        isRepertoireStale = true;
                                                                    })();
                                                                ">×</button>
                                                            </li>
                                                        </template>
                                                        <template x-if="!log.repertoire || log.repertoire.length === 0">
                                                            <li class="text-sm text-gray-500 py-2 px-2">No tunes linked yet.</li>
                                                        </template>
                                                    </ul>

                                                    <div class="border-t border-gray-200 pt-3">
                                                        <h5 class="text-sm font-semibold text-gray-900 mb-2">Add Tune</h5>
                                                        <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 mb-2" placeholder="Search repertoire..." x-model="searchTerm"
                                                            @input.debounce.300ms="dataLayer.searchRepertoire(searchTerm).then(data => searchResults = data)">
                                                        <ul class="max-h-40 overflow-y-auto" x-show="searchTerm.length > 1">
                                                            <template
                                                                x-for="result in searchResults.filter(r => !log.repertoire || !log.repertoire.some(linked => linked.id === r.id))">
                                                                <li class="text-sm text-gray-900 py-2 px-2 hover:bg-gray-100 rounded cursor-pointer" @click="
                                                                    (async () => {
                                                                        await dataLayer.linkRepertoireToLog(log.id, result.id);
                                                                        if (!log.repertoire) log.repertoire = [];
                                                                        log.repertoire.push(result);
                                                                        searchTerm = '';
                                                                        searchResults = [];
                                                                        const supabaseClient = dataLayer.getSupabaseClient();
                                                                        await supabaseClient.rpc('update_repertoire_stats', { rep_id: result.id });
                                                                        isRepertoireStale = true;
                                                                    })();
                                                                ">
                                                                    <span x-text="result.title + (result.artist ? ' - ' + result.artist : '')"></span>
                                                                </li>
                                                            </template>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <button class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-3 py-1.5" @click="isEditLogModalOpen = true; editingLog = log; editingLogGoal = goal;">
                                                <i data-feather="edit-2"></i>
                                            </button>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                            <div class="mt-3 flex gap-2">
                                <template x-if="!goal.showAllLogs && goal.logs.filter(log => log.date !== practiceDate).length > 0">
                                    <button
                                        class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-3 py-1.5"
                                        @click="
                                            goal.showAllLogs = true;
                                            $nextTick(() => feather.replace());
                                        ">
                                        Show All (<span x-text="goal.logs.length"></span>)
                                    </button>
                                </template>
                                <template x-if="goal.showAllLogs">
                                    <button class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-3 py-1.5" @click="goal.showAllLogs = false">
                                        Show Session Logs Only
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </details>
            </template>

            <!-- Clear Session Button -->
            <div class="mt-6 text-center">
                <button
                    class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5"
                    @click="if (confirm('Clear this entire practice session? This will remove all goals from the session but will not delete any logs.')) clearPracticeSession()"
                >Clear Session</button>
            </div>
        </div>
    </template>
</div>
