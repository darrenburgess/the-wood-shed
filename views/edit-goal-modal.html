<div
    class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50"
    x-show="isEditGoalModalOpen"
    x-cloak
    @keydown.escape.window="isEditGoalModalOpen = false"
>
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6" @click.outside="isEditGoalModalOpen = false">
        <h3 class="text-xl font-semibold mb-4 text-gray-900">Edit Goal</h3>
        <template x-if="editingGoal">
            <textarea
                x-model="editingGoal.description"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 mb-4"
                rows="3"
                @keydown.enter="
                    if (!$event.shiftKey) {
                        $event.preventDefault();
                        dataLayer.updateGoal(editingGoal.id, editingGoal.description);
                        isEditGoalModalOpen = false;
                        editingGoal = null;
                    }
                "
            ></textarea>
        </template>
        <div class="flex justify-between">
            <div class="flex gap-2">
                <button
                    class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5"
                    @click="
                        if (confirm('Are you sure you want to delete this goal and all its logs?')) {
                            const statsUpdated = await dataLayer.deleteGoal(editingGoal);
                            if (statsUpdated) isRepertoireStale = true;

                            // Remove goal from local state for instant UI update
                            const topic = topics.find(t => t.id === editingGoal.topic_id);
                            if (topic) {
                                topic.goals = topic.goals.filter(g => g.id !== editingGoal.id);
                            }
                            isEditGoalModalOpen = false;
                            editingGoal = null;
                        }
                    "
                >Delete</button>
                <button
                    class="text-gray-900 bg-yellow-400 hover:bg-yellow-500 focus:ring-4 focus:ring-yellow-300 font-medium rounded-lg text-sm px-5 py-2.5"
                    x-text="editingGoal?.is_complete ? 'Re-open Goal' : 'Complete Goal'"
                    @click="
                        const updatedGoal = await dataLayer.toggleGoalComplete(editingGoal);
                        if (updatedGoal) {
                            // Find and update the goal in the local state
                            const topic = topics.find(t => t.id === updatedGoal.topic_id);
                            if (topic) {
                                const goalIndex = topic.goals.findIndex(g => g.id === updatedGoal.id);
                                topic.goals[goalIndex] = updatedGoal;
                                $nextTick(() => feather.replace());
                            }
                        }
                        isEditGoalModalOpen = false;
                        editingGoal = null;
                    "
                ></button>
            </div>
            <div class="flex gap-2">
                <button class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-5 py-2.5" @click="isEditGoalModalOpen = false; editingGoal = null">Cancel</button>
                <button
                    class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5"
                    @click="
                        dataLayer.updateGoal(editingGoal.id, editingGoal.description);
                        isEditGoalModalOpen = false;
                        editingGoal = null;
                    "
                >Save Changes</button>
            </div>
        </div>
    </div>
</div>
