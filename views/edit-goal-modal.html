<div 
    class="modal-overlay" 
    x-show="isEditGoalModalOpen" 
    x-cloak 
    @keydown.escape.window="isEditGoalModalOpen = false"
>
    <div class="modal-content" @click.outside="isEditGoalModalOpen = false">
        <h3>Edit Goal</h3>
        <template x-if="editingGoal">
            <textarea x-model="editingGoal.description"></textarea>
        </template>
        <div class="modal-actions">
            <div>
                <button 
                    class="btn-delete"
                    @click="
                        if (confirm('Are you sure you want to delete this goal and all its logs?')) {
                            const statsUpdated = await dataLayer.deleteGoal(editingGoal);
                            if (statsUpdated) isRepertoireStale = true;
                            
                            // Remove goal from local state for instant UI update
                            const topic = topics.find(t => t.id === editingGoal.topic_id);
                            if (topic) {
                                topic.goals = topic.goals.filter(g => g.id !== editingGoal.id);
                            }
                            isEditGoalModalOpen = false;
                            editingGoal = null;
                        }
                    "
                >Delete</button>
                <button
                    x-text="editingGoal?.is_complete ? 'Re-open Goal' : 'Complete Goal'"
                    @click="
                        const updatedGoal = await dataLayer.toggleGoalComplete(editingGoal);
                        if (updatedGoal) {
                            // Find and update the goal in the local state
                            const topic = topics.find(t => t.id === updatedGoal.topic_id);
                            if (topic) {
                                const goalIndex = topic.goals.findIndex(g => g.id === updatedGoal.id);
                                topic.goals[goalIndex] = updatedGoal;
                                $nextTick(() => feather.replace());
                            }
                        }
                        isEditGoalModalOpen = false;
                        editingGoal = null;
                    "
                >Complete Goal</button>
            </div>
            <div class="right-actions">
                <button @click="isEditGoalModalOpen = false; editingGoal = null">Cancel</button>
                <button 
                    class="btn-save"
                    @click="
                        dataLayer.updateGoal(editingGoal.id, editingGoal.description);
                        isEditGoalModalOpen = false; 
                        editingGoal = null;
                    "
                >Save Changes</button>
            </div>
        </div>
    </div>
</div>