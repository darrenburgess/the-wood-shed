            <div class="mb-4">
                <button class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5" @click="editingRepertoire = { title: '', artist: '', tags: [] }; isRepertoireModalOpen = true;">
                    New Repertoire
                </button>
            </div>
            <div x-show="isRepertoireLoading" class="text-center py-8 text-gray-500">Loading Repertoire...</div>

            <div x-show="!isRepertoireLoading">
                <!-- All Available Tags -->
                <div x-show="allRepertoireTags.length > 0" class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="font-medium mb-2 text-gray-700">Filter by tag:</div>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="tag in allRepertoireTags" :key="tag.id">
                            <span
                                :class="repertoireTagFilters.some(t => t.id === tag.id) ? 'bg-gray-300 text-gray-600 cursor-default' : 'bg-blue-100 text-blue-800 hover:bg-blue-200 cursor-pointer'"
                                class="text-xs font-medium px-2.5 py-0.5 rounded"
                                @click="
                                    if (!repertoireTagFilters.some(t => t.id === tag.id)) {
                                        repertoireTagFilters.push(tag);
                                    }
                                "
                                :title="repertoireTagFilters.some(t => t.id === tag.id) ? 'Already filtering by this tag' : 'Click to filter by this tag'"
                            >
                                <span x-text="tag.name + ' (' + tag.count + ')'"></span>
                            </span>
                        </template>
                    </div>
                </div>

                <!-- Active Tag Filters -->
                <div x-show="repertoireTagFilters.length > 0" class="mb-4">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="font-medium text-gray-700">Filtering by:</span>
                        <template x-for="filterTag in repertoireTagFilters" :key="filterTag.id">
                            <span class="inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">
                                <span x-text="filterTag.name"></span>
                                <button type="button" class="ml-1 text-blue-600 hover:text-blue-800 font-bold" @click="repertoireTagFilters = repertoireTagFilters.filter(t => t.id !== filterTag.id)">Ã—</button>
                            </span>
                        </template>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="mb-4">
                    <div class="flex gap-2 items-center">
                        <input
                            type="text"
                            x-model="repertoireSearchTerm"
                            placeholder="Search by title, composer, tag, progress... (e.g., 'count > 5' or 'date > 01/15/2025')"
                            class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                        >
                        <button
                            x-show="repertoireSearchTerm.trim() || repertoireTagFilters.length > 0"
                            @click="repertoireSearchTerm = ''; repertoireTagFilters = []"
                            class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-5 py-2.5 whitespace-nowrap"
                        >Clear All Filters</button>
                    </div>
                    <div x-show="repertoireSearchTerm.trim() || repertoireTagFilters.length > 0" class="mt-2 text-sm text-gray-600">
                        Showing <strong x-text="sortedRepertoire.length"></strong> of <strong x-text="repertoire.length"></strong> pieces
                    </div>
                </div>
            </div>

            <div x-show="!isRepertoireLoading" class="relative overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th @click="sortRepertoireBy('title')" class="px-6 py-3 sortable">Title</th>
                            <th class="px-6 py-3">Tags</th>
                            <th @click="sortRepertoireBy('practice_count')" class="px-6 py-3 sortable" style="width: 80px;">Count</th>
                            <th @click="sortRepertoireBy('last_practiced')" class="px-6 py-3 sortable whitespace-nowrap" style="width: 110px;">Last Date</th>
                            <th @click="sortRepertoireBy('progress')" class="px-6 py-3 sortable" style="width: 200px;">Progress</th>
                            <th class="px-6 py-3" style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="tune in sortedRepertoire" :key="tune.id">
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="px-6 py-4" :title="tune.artist || ''" x-text="tune.title"></td>
                                <td class="px-6 py-4">
                                    <template x-if="tune.tags && tune.tags.length > 0">
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="tag in tune.tags" :key="tag.id">
                                                <span
                                                    class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded hover:bg-blue-200 cursor-pointer"
                                                    x-text="tag.name"
                                                    @click="
                                                        if (!repertoireTagFilters.some(t => t.id === tag.id)) {
                                                            repertoireTagFilters.push(tag);
                                                        }
                                                    "
                                                    title="Click to filter by this tag"
                                                ></span>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-if="!tune.tags || tune.tags.length === 0">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-6 py-4" x-text="tune.practice_count"></td>
                                <td class="px-6 py-4"
                                    x-text="tune.last_practiced ? new Date(tune.last_practiced + 'T00:00:00').toLocaleDateString('en-US') : 'Never'">
                                </td>
                                <td class="px-6 py-4">
                                    <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" x-model="tune.progress"
                                        @change="dataLayer.updateRepertoireProgress(tune.id, $event.target.value)">
                                        <option>1 - Backlog</option>
                                        <option>2 - Listening</option>
                                        <option>3 - Started</option>
                                        <option>4 - Memorized</option>
                                        <option>5 - Gig Ready</option>
                                        <option>6 - Off Book</option>
                                    </select>
                                </td>
                                <td class="px-6 py-4">
                                    <button class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-3 py-1.5" @click="editingRepertoire = { ...tune }; isRepertoireModalOpen = true;">
                                        <i data-feather="edit-2"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
