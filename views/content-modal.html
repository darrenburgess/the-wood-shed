<div
    class="modal-overlay"
    x-show="isContentModalOpen"
    x-cloak
    @keydown.escape.window="isContentModalOpen = false"
>
    <div class="modal-content" @click.outside="isContentModalOpen = false"
        x-data="{
            tagSearchTerm: '',
            tagSearchResults: [],
            selectedTags: []
        }"
        x-init="
            $watch('isContentModalOpen', (isOpen) => {
                if (isOpen && editingContent) {
                    selectedTags = editingContent.tags ? [...editingContent.tags] : [];
                    tagSearchTerm = '';
                    tagSearchResults = [];
                }
            })
        ">
        <h3 x-text="editingContent?.id ? 'Edit Content' : 'Add New Content'"></h3>

        <template x-if="editingContent">
            <div class="create-content-panel" @keydown.enter="
                if ($event.target.classList.contains('tag-search-input')) {
                    return; // Don't save when pressing Enter in tag search
                }
                $event.preventDefault();
                (async () => {
                    if (editingContent.id) {
                        // Update existing content
                        const updated = await dataLayer.updateContent(editingContent.id, editingContent.title, editingContent.url, editingContent.type);
                        if (updated) {
                            // Sync tags
                            await dataLayer.syncContentTags(editingContent.id, selectedTags);
                            updated.tags = selectedTags;
                            const index = content.findIndex(c => c.id === updated.id);
                            content[index] = updated;
                            isContentModalOpen = false;
                        }
                    } else {
                        // Create new content
                        const newContent = await dataLayer.createContent(editingContent.title, editingContent.url, editingContent.type);
                        if (newContent) {
                            // Link tags to new content
                            await dataLayer.syncContentTags(newContent.id, selectedTags);
                            newContent.tags = selectedTags;
                            content.unshift(newContent);
                            $nextTick(() => feather.replace());
                            isContentModalOpen = false;
                        } else {
                            alert('Error: A content item with this URL already exists.');
                        }
                    }
                })();
            ">
                <input type="text" x-model="editingContent.title" placeholder="Title">
                <input type="url" x-model="editingContent.url" placeholder="https://...">
                <select x-model="editingContent.type">
                    <option>YouTube</option>
                    <option>Article</option>
                    <option>Image</option>
                    <option>PDF</option>
                </select>

                <!-- Tag Input -->
                <div class="tag-input-container">
                    <label>Tags</label>

                    <!-- Selected Tags Display -->
                    <div class="selected-tags">
                        <template x-for="tag in selectedTags" :key="tag.id">
                            <span class="tag-pill">
                                <span x-text="tag.name"></span>
                                <button type="button" @click="selectedTags = selectedTags.filter(t => t.id !== tag.id)">Ã—</button>
                            </span>
                        </template>
                    </div>

                    <!-- Tag Search Input -->
                    <div class="tag-search" style="position: relative;">
                        <input
                            type="text"
                            class="tag-search-input"
                            x-model="tagSearchTerm"
                            placeholder="Add tags..."
                            @input.debounce.300ms="
                                if (tagSearchTerm.length > 0) {
                                    dataLayer.searchTags(tagSearchTerm).then(results => {
                                        tagSearchResults = results.filter(r => !selectedTags.some(st => st.id === r.id));
                                    });
                                } else {
                                    tagSearchResults = [];
                                }
                            "
                            @keydown.enter.prevent="
                                if (tagSearchTerm.trim()) {
                                    // Create new tag
                                    dataLayer.createTag(tagSearchTerm).then(newTag => {
                                        if (newTag && !selectedTags.some(t => t.id === newTag.id)) {
                                            selectedTags.push(newTag);
                                        }
                                        tagSearchTerm = '';
                                        tagSearchResults = [];
                                    });
                                }
                            "
                        >

                        <!-- Autocomplete Results -->
                        <div x-show="tagSearchTerm.length > 0" style="position: absolute; z-index: 1000; width: 100%; top: 100%;" @click.outside="tagSearchTerm = ''; tagSearchResults = []">
                            <ul class="results-list" x-show="tagSearchResults.length > 0">
                                <template x-for="result in tagSearchResults" :key="result.id">
                                    <li @click="
                                        selectedTags.push(result);
                                        tagSearchTerm = '';
                                        tagSearchResults = [];
                                    ">
                                        <span x-text="result.name"></span>
                                    </li>
                                </template>
                            </ul>

                            <!-- Create new tag hint -->
                            <ul class="results-list" x-show="tagSearchResults.length === 0 && tagSearchTerm.trim().length > 0">
                                <li @click="
                                    (async () => {
                                        const newTag = await dataLayer.createTag(tagSearchTerm);
                                        if (newTag && !selectedTags.some(t => t.id === newTag.id)) {
                                            selectedTags.push(newTag);
                                        }
                                        tagSearchTerm = '';
                                        tagSearchResults = [];
                                    })();
                                " style="font-style: italic; color: var(--accent-color); cursor: pointer;">
                                    <span>Create new tag: <strong x-text="tagSearchTerm"></strong></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <div class="modal-actions">
            <div>
                <button
                    class="btn-delete"
                    x-show="editingContent?.id"
                    @click="
                        if (confirm('Are you sure? This will also remove links from any logs.')) {
                            dataLayer.deleteContent(editingContent.id);
                            content = content.filter(c => c.id !== editingContent.id);
                            isContentModalOpen = false;
                        }
                    "
                >Delete</button>
            </div>
            <div class="right-actions">
                <button @click="isContentModalOpen = false; editingContent = null">Cancel</button>
                <button
                    class="btn-save"
                    @click="
                        (async () => {
                            if (editingContent.id) {
                                // Update existing content
                                const updated = await dataLayer.updateContent(editingContent.id, editingContent.title, editingContent.url, editingContent.type);
                                if (updated) {
                                    // Sync tags
                                    await dataLayer.syncContentTags(editingContent.id, selectedTags);
                                    updated.tags = selectedTags;
                                    const index = content.findIndex(c => c.id === updated.id);
                                    content[index] = updated;
                                    isContentModalOpen = false;
                                }
                            } else {
                                // Create new content
                                const newContent = await dataLayer.createContent(editingContent.title, editingContent.url, editingContent.type);
                                if (newContent) {
                                    // Link tags to new content
                                    await dataLayer.syncContentTags(newContent.id, selectedTags);
                                    newContent.tags = selectedTags;
                                    content.unshift(newContent);
                                    $nextTick(() => feather.replace());
                                    isContentModalOpen = false;
                                } else {
                                    alert('Error: A content item with this URL already exists.');
                                }
                            }
                        })();
                    "
                >Save</button>
            </div>
        </div>
    </div>
</div>
