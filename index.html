<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wood Shed</title>

    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="app.js" defer></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div id="auth-container" class="container">
        <h1>The Wood Shed</h1>
        <form id="auth-form">
            <input type="email" id="auth-email" placeholder="Email" required>
            <input type="password" id="auth-password" placeholder="Password" required>
            <div class="auth-actions">
                <button type="submit" id="sign-in-btn">Sign In</button>
                <button type="button" id="sign-up-btn">Sign Up</button>
            </div>
        </form>
        <p id="auth-error" class="error-message hidden"></p>
    </div>

    <div 
        class="container hidden" 
        id="app-container"
        x-data="{ 
            currentUser: null,
            topics: [],
            isLoading: true,
            activeView: 'plan',
            isDevEnvironment: (window.location.hostname === 'localhost' || window.location.protocol === 'file:'),
            isNewTopicModalOpen: false,
            newTopicTitle: '',
            isEditTopicModalOpen: false,
            editingTopic: null,
            isEditGoalModalOpen: false,
            editingGoal: null,
            isEditLogModalOpen: false,
            editingLog: null,
            editingLogGoal: null,
            
            // State for the Logs View
            logs: [],
            isLogsLoading: false,
            logViewDate: new Date(),
            logViewTitle: 'Today\'s Logs',
            searchStartDate: '',
            searchEndDate: '',

            // Methods
            async loadData() {
                this.isLoading = true;
                this.topics = await dataLayer.fetchPlanData();
                this.isLoading = false;
                this.$nextTick(() => feather.replace());
            },
            expandAll() {
                this.topics.forEach(topic => {
                    topic.isOpen = true;
                    if (topic.goals) {
                        topic.goals.forEach(goal => goal.isOpen = true);
                    }
                });
            },
            collapseAll() {
                this.topics.forEach(topic => {
                    topic.isOpen = false;
                    if (topic.goals) {
                        topic.goals.forEach(goal => goal.isOpen = false);
                    }
                });
            },
            
            // New methods for the Logs View
            formatDate(date) {
                return date.toISOString().split('T')[0];
            },
            async getLogsForDate(date) {
                this.isLogsLoading = true;
                this.logViewTitle = `Logs for ${date.toLocaleDateString('en-US')}`;
                const dateString = this.formatDate(date);
                this.logs = await dataLayer.fetchLogsByDateRange(dateString, dateString);
                this.isLogsLoading = false;
            },
            async prevDay() {
                this.logViewDate.setDate(this.logViewDate.getDate() - 1);
                this.getLogsForDate(this.logViewDate);
            },
            async nextDay() {
                this.logViewDate.setDate(this.logViewDate.getDate() + 1);
                this.getLogsForDate(this.logViewDate);
            },
            async searchDateRange() {
                if (!this.searchStartDate || !this.searchEndDate) return;
                this.isLogsLoading = true;
                this.logViewTitle = `Logs from ${this.searchStartDate} to ${this.searchEndDate}`;
                this.logs = await dataLayer.fetchLogsByDateRange(this.searchStartDate, this.searchEndDate);
                this.isLogsLoading = false;
            },
            
            // Computed property to group logs for display
            get groupedLogs() {
                return this.logs.reduce((acc, log) => {
                    if (!log.goals || !log.goals.topics) return acc;
                    const topicTitle = log.goals.topics.title;
                    const goalDesc = `${log.goals.goal_number}: ${log.goals.description}`;
                    
                    if (!acc[topicTitle]) acc[topicTitle] = {};
                    if (!acc[topicTitle][goalDesc]) acc[topicTitle][goalDesc] = [];
                    
                    acc[topicTitle][goalDesc].push(log);
                    return acc;
                }, {});
            }
        }"
        @user-signed-in.window="loadData()"
        x-effect="if (isDevEnvironment) document.title = '(Dev) The Wood Shed'; if (activeView === 'logs' && logs.length === 0) getLogsForDate(logViewDate);"
    >
        <div class="app-header">
            <h1 id="app-title">
                The Wood Shed
                <span x-show="isDevEnvironment" style="font-weight: 500; color: #a0aec0;">(Dev)</span>
            </h1>
            <button id="sign-out-btn" @click="supabaseClient.auth.signOut()">Sign Out</button>
        </div>
        
        <div class="tabs">
            <button class="tab-btn" :class="{ 'active': activeView === 'plan' }" @click="activeView = 'plan'">Plan</button>
            <button class="tab-btn" :class="{ 'active': activeView === 'logs' }" @click="activeView = 'logs'">Logs</button>
        </div>

        <div id="plan-view" x-show="activeView === 'plan'">
           <div class="main-controls">
                <button id="add-topic-btn" @click="isNewTopicModalOpen = true" class="btn-new">New Topic</button>
                <button @click="expandAll()">Expand All</button>
                <button @click="collapseAll()">Collapse All</button>
            </div>

            <div x-show="isLoading" style="text-align: center; padding: 2rem;">Loading your plan...</div>
            
            <div x-show="!isLoading">
                <template x-for="topic in topics" :key="topic.id">
                    <details class="topic-details" :open="topic.isOpen" @toggle="topic.isOpen = $event.target.open">
                        <summary class="summary-flex">
                            <h2>
                                Topic <span x-text="topic.topic_number"></span>: 
                                <span x-text="topic.title"></span>
                            </h2>
                            <button 
                                class="edit-btn" 
                                @click.prevent="isEditTopicModalOpen = true; editingTopic = topic"
                            >
                                <i data-feather="edit-2"></i>
                            </button> 
                        </summary>
                        
                        <div>
                            <div class="topic-content">
                                <template x-for="goal in topic.goals.filter(g => !g.is_complete)" :key="goal.id">
                                    <details class="goal-details" :open="goal.isOpen" @toggle="goal.isOpen = $event.target.open">
                                        <summary class="summary-flex">
                                            <span class="goal-text">
                                                <strong><span x-text="goal.goal_number"></span>:</strong>
                                                <span x-text="goal.description"></span>
                                            </span>
                                            <button class="edit-btn" @click.prevent="isEditGoalModalOpen = true; editingGoal = goal">
                                                <i data-feather="edit-2"></i>
                                            </button>
                                        </summary>
                                        <div>
                                            <form 
                                                class="add-log-form"
                                                x-data="{ 
                                                    newLogEntry: '',
                                                    searchOpen: false, 
                                                    searchTerm: '', 
                                                    searchResults: [], 
                                                    isLoading: false, 
                                                    selectedContent: [] 
                                                }"
                                                @submit.prevent="
                                                    const newLog = await dataLayer.addLog(goal.id, newLogEntry, selectedContent.map(c => c.id));
                                                    if (newLog) {
                                                        newLog.content = selectedContent; // Attach content locally for display
                                                        goal.logs.unshift(newLog); // Add to beginning of logs list
                                                        newLogEntry = '';
                                                        selectedContent = [];
                                                        $nextTick(() => feather.replace());
                                                    }
                                                "
                                            >
                                                <input type="text" name="logEntry" class="log-input" placeholder="New log entry..." required x-model="newLogEntry">
                                                <button type="button" @click="searchOpen = !searchOpen" class="content-btn" title="Add Content">🔗</button>
                                                <button type="submit">Add Log</button>

                                                <div x-show="searchOpen" @click.outside="searchOpen = false" class="search-panel">
                                                    <input 
                                                        type="text" 
                                                        x-model.debounce.300ms="
                                                            isLoading = true; 
                                                            dataLayer.searchContent(searchTerm).then(data => { 
                                                                searchResults = data; 
                                                                isLoading = false;
                                                            })
                                                        " 
                                                        placeholder="Search your content library..." 
                                                        class="search-input"
                                                    >
                                                    <ul x-show="!isLoading" class="results-list">
                                                        <template x-for="result in searchResults" :key="result.id">
                                                            <li @click="selectedContent.push(result); searchOpen = false; searchTerm = ''">
                                                                <span x-text="result.title"></span>
                                                            </li>
                                                        </template>
                                                    </ul>
                                                </div>

                                                <div class="pills-container">
                                                    <template x-for="item in selectedContent" :key="item.id">
                                                        <span class="pill">
                                                            <span x-text="item.title"></span>
                                                            <button type="button" @click="selectedContent = selectedContent.filter(c => c.id !== item.id)">×</button>
                                                        </span>
                                                    </template>
                                                </div>
                                            </form>

                                            <ul class="log-list">
                                                <template x-for="log in goal.logs.slice(0, goal.logsToShow)" :key="log.id">
                                                    <li>
                                                        <span class="log-date" x-text="new Date(log.date).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>:
                                                        <span class="log-entry" x-html="dataLayer.linkify(log.entry)"></span>
                                                        <button class="edit-btn" @click="isEditLogModalOpen = true; editingLog = log; editingLogGoal = goal;">
                                                            <i data-feather="edit-2"></i>
                                                        </button>
                                                    </li>
                                                </template>
                                            </ul>
                                            <div class="log-controls">
                                                <template x-if="goal.logs.length > 5 && goal.logsToShow < goal.logs.length">
                                                    <button class="toggle-logs-btn" @click="goal.logsToShow = goal.logs.length">
                                                        Show All (<span x-text="goal.logs.length"></span>)
                                                    </button>
                                                </template>
                                                <template x-if="goal.logsToShow > 5">
                                                    <button class="toggle-logs-btn" @click="goal.logsToShow = 5">
                                                        Show Less
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </details>
                                </template>                                

                                <template x-if="topic.goals.some(g => g.is_complete)">
                                    <div>
                                        <h4>Completed Goals</h4>
                                        <template x-for="goal in topic.goals.filter(g => g.is_complete)" :key="goal.id">
                                            <details class="goal-details completed-goal" :open="goal.isOpen" @toggle="goal.isOpen = $event.target.open">
                                                <summary class="summary-flex">
                                                    <span class="goal-text">
                                                        <strong><span x-text="goal.goal_number"></span>:</strong>
                                                        <span x-text="goal.description"></span>
                                                        <em>(Completed: <span x-text="new Date(goal.date_completed).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>)</em>
                                                    </span>
                                                    <button class="edit-btn" @click.prevent="isEditGoalModalOpen = true; editingGoal = goal">
                                                        <i data-feather="edit-2"></i>
                                                    </button>    
                                                </summary>
                                                <div>
                                                <ul class="log-list">
                                                    <template x-for="log in goal.logs" :key="log.id">
                                                        <li>
                                                            <span class="log-date" x-text="new Date(log.date).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>:
                                                            <span class="log-entry" x-html="dataLayer.linkify(log.entry)"></span>
                                                        </li>
                                                    </template>
                                                </ul>
                                            </div>
                                            </details>
                                        </template>
                                    </div>
                                </template>
                            </div>                       
                        </div>

                        <form 
                            class="add-goal-form" 
                            x-data="{ newGoalDescription: '' }"
                            @submit.prevent="
                                const newGoal = await dataLayer.addGoal(topic, newGoalDescription);
                                if (newGoal) {
                                    // Add the new goal to the topic's local array
                                    newGoal.logs = [];
                                    newGoal.isOpen = false;
                                    topic.goals.push(newGoal);
                                    $nextTick(() => feather.replace());
                                    // Reset the input field
                                    newGoalDescription = '';
                                }
                            "
                        >
                            <input type="text" x-model="newGoalDescription" class="goal-input" placeholder="New goal description..." required>
                            <button type="submit">Add Goal</button>
                        </form>

                    </details>
                </template>
            </div>
        </div>

        <div id="logs-view" x-show="activeView === 'logs'">
            <div class="log-view-header">
                <div class="date-nav">
                    <button @click="prevDay()">&lt;</button>
                    <h2 x-text="logViewTitle"></h2>
                    <button @click="nextDay()">&gt;</button>
                </div>
                <div class="date-range-search">
                    <input type="date" x-model="searchStartDate">
                    <span>to</span>
                    <input type="date" x-model="searchEndDate">
                    <button @click="searchDateRange()">Search</button>
                </div>
            </div>
            
            <div id="log-view-content">
                <div x-show="isLogsLoading" style="text-align: center; padding: 2rem;">Loading logs...</div>
                
                <div x-show="!isLogsLoading">
                    <template x-if="Object.keys(groupedLogs).length === 0">
                        <p>No practice logged for this period.</p>
                    </template>

                    <template x-for="(goals, topicTitle) in groupedLogs" :key="topicTitle">
                        <div>
                            <h2 x-text="topicTitle"></h2>
                            <template x-for="(logEntries, goalDescription) in goals" :key="goalDescription">
                                <div>
                                    <h4 x-text="goalDescription"></h4>
                                    <ul class="log-list-flat">
                                        <template x-for="log in logEntries" :key="log.id">
                                            <li x-html="dataLayer.linkify(log.entry)"></li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isNewTopicModalOpen" 
            x-cloak 
            @keydown.escape.window="isNewTopicModalOpen = false"
        >
            <div class="modal-content" @click.outside="isNewTopicModalOpen = false">
                <h3>Add New Topic</h3>
                <textarea 
                    x-model="newTopicTitle" 
                    placeholder="Enter title for the new topic..."
                ></textarea>
                <div class="modal-actions">
                    <div></div> <div class="right-actions">
                        <button @click="isNewTopicModalOpen = false; newTopicTitle = ''">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                const newTopic = await dataLayer.addTopic(newTopicTitle);
                                if (newTopic) {
                                    newTopic.goals = []; 
                                    newTopic.isOpen = true;
                                    topics.push(newTopic); 
                                    $nextTick(() => feather.replace());
                                }
                                isNewTopicModalOpen = false; 
                                newTopicTitle = '';
                            "
                        >Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isEditTopicModalOpen" 
            x-cloak 
            @keydown.escape.window="isEditTopicModalOpen = false"
        >
            <div class="modal-content" @click.outside="isEditTopicModalOpen = false">
                <h3>Edit Topic</h3>
                <template x-if="editingTopic">
                    <textarea x-model="editingTopic.title"></textarea>
                </template>
                <div class="modal-actions">
                    <div></div> <div class="right-actions">
                        <button @click="isEditTopicModalOpen = false; editingTopic = null">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                dataLayer.updateTopicTitle(editingTopic.id, editingTopic.title);
                                isEditTopicModalOpen = false; 
                                editingTopic = null;
                            "
                        >Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isEditGoalModalOpen" 
            x-cloak 
            @keydown.escape.window="isEditGoalModalOpen = false"
        >
            <div class="modal-content" @click.outside="isEditGoalModalOpen = false">
                <h3>Edit Goal</h3>
                <template x-if="editingGoal">
                    <textarea x-model="editingGoal.description"></textarea>
                </template>
                <div class="modal-actions">
                    <div>
                        <button 
                            class="btn-delete"
                            @click="
                                if (confirm('Are you sure you want to delete this goal and all its logs?')) {
                                    dataLayer.deleteGoal(editingGoal.id);
                                    // Remove goal from local state for instant UI update
                                    const topic = topics.find(t => t.id === editingGoal.topic_id);
                                    if (topic) {
                                        topic.goals = topic.goals.filter(g => g.id !== editingGoal.id);
                                    }
                                    isEditGoalModalOpen = false;
                                    editingGoal = null;
                                }
                            "
                        >Delete</button>
                        <button
                            x-text="editingGoal?.is_complete ? 'Re-open Goal' : 'Complete Goal'"
                            @click="
                                const updatedGoal = await dataLayer.toggleGoalComplete(editingGoal);
                                if (updatedGoal) {
                                    // Find and update the goal in the local state
                                    const topic = topics.find(t => t.id === updatedGoal.topic_id);
                                    if (topic) {
                                        const goalIndex = topic.goals.findIndex(g => g.id === updatedGoal.id);
                                        topic.goals[goalIndex] = updatedGoal;
                                        $nextTick(() => feather.replace());
                                    }
                                }
                                isEditGoalModalOpen = false;
                                editingGoal = null;
                            "
                        >Complete Goal</button>
                    </div>
                    <div class="right-actions">
                        <button @click="isEditGoalModalOpen = false; editingGoal = null">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                dataLayer.updateGoal(editingGoal.id, editingGoal.description);
                                isEditGoalModalOpen = false; 
                                editingGoal = null;
                            "
                        >Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isEditLogModalOpen" 
            x-cloak 
            @keydown.escape.window="isEditLogModalOpen = false"
        >
            <div class="modal-content" @click.outside="isEditLogModalOpen = false">
                <h3>Edit Log</h3>
                <template x-if="editingLog">
                    <textarea x-model="editingLog.entry"></textarea>
                </template>
                <div class="modal-actions">
                    <div>
                        <button 
                            class="btn-delete"
                            @click="
                                if (confirm('Are you sure you want to delete this log entry?')) {
                                    dataLayer.deleteLog(editingLog.id);
                                    // Remove log from local state for instant UI update
                                    if (editingLogGoal) {
                                        editingLogGoal.logs = editingLogGoal.logs.filter(l => l.id !== editingLog.id);
                                    }
                                    isEditLogModalOpen = false;
                                }
                            "
                        >Delete</button>
                    </div>
                    <div class="right-actions">
                        <button @click="isEditLogModalOpen = false">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                dataLayer.updateLog(editingLog.id, editingLog.entry);
                                isEditLogModalOpen = false; 
                            "
                        >Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>