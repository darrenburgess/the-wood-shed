<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wood Shed</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="app.js" defer></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div id="auth-container" class="container">
        <h1>The Wood Shed</h1>
        <form id="auth-form">
            <input type="email" id="auth-email" placeholder="Email" required>
            <input type="password" id="auth-password" placeholder="Password" required>
            <div class="auth-actions">
                <button type="submit" id="sign-in-btn">Sign In</button>
                <button type="button" id="sign-up-btn">Sign Up</button>
            </div>
        </form>
        <p id="auth-error" class="error-message hidden"></p>
    </div>

    <div 
        class="container hidden" 
        id="app-container"
        x-data="{ 
            currentUser: null,
            topics: [],
            isLoading: true,
            activeView: 'plan',
            isDevEnvironment: (window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:'),
            isNewTopicModalOpen: false,
            newTopicTitle: '',
            isEditTopicModalOpen: false,
            editingTopic: null,
            isEditGoalModalOpen: false,
            editingGoal: null,
            isEditLogModalOpen: false,
            editingLog: null,
            editingLogGoal: null,
            isAddLogModalOpen: false,
            loggingForGoal: null,
            isContentModalOpen: false,
            editingContent: null,
            isYouTubeModalOpen: false,
            youTubeVideoId: '',

            // State for the Logs View
            logs: [],
            isLogsLoading: false,
            logsLoaded: false,
            logViewDate: new Date(),
            logViewTitle: 'Today\'s Logs',
            searchStartDate: '',
            searchEndDate: '',

            // State for the Content View
            content: [],
            isContentLoading: false,

            // State for Repertoire View
            repertoire: [],
            isRepertoireLoading: false,
            isRepertoireStale: false,
            isRepertoireModalOpen: false,
            editingRepertoire: null,
            repertoireSortKey: 'last_practiced',
            repertoireSortDirection: 'desc',

            // --- METHODS ---
            uiState: $persist({ 
                topicStates: {}, 
                goalStates: {},
                completedGoalStates: {} 
            }),
            async loadData() {
                this.isLoading = true;
                const fetchedTopics = await dataLayer.fetchPlanData();

                // Only add properties that don't need to be persisted
                fetchedTopics.forEach(topic => {
                    if (topic.goals) {
                        topic.goals.forEach(goal => {
                            goal.logsToShow = 5;
                        });
                    }
                });
                
                this.topics = fetchedTopics;
                this.isLoading = false;
                    this.$nextTick(() => {
                    feather.replace();
                  
                    const savedPosition = localStorage.getItem('scrollPosition');
                    if (savedPosition) {
                        window.scrollTo(0, parseInt(savedPosition));
                    }
                });
            },
            expandAll() {
                this.topics.forEach(topic => {
                    this.uiState.topicStates[topic.id] = true;
                    if (topic.goals) {
                        topic.goals.filter(g => !g.is_complete).forEach(goal => this.uiState.goalStates[goal.id] = true);
                    }
                });
            },
            collapseAll() {
                this.topics.forEach(topic => {
                    this.uiState.topicStates[topic.id] = false;
                    if (topic.goals) {
                        topic.goals.forEach(goal => this.uiState.goalStates[goal.id] = false);
                    }
                });
            },
            // Logs View Methods
            formatDate(date) {
                return date.toISOString().split('T')[0];
            },
            async getLogsForDate(date) {
                this.isLogsLoading = true;
                this.logViewTitle = `Logs for ${date.toLocaleDateString('en-US')}`;
                const dateString = this.formatDate(date);
                this.logs = await dataLayer.fetchLogsByDateRange(dateString, dateString);
                this.isLogsLoading = false;
            },
            async prevDay() {
                this.logViewDate.setDate(this.logViewDate.getDate() - 1);
                this.getLogsForDate(this.logViewDate);
            },
            async nextDay() {
                this.logViewDate.setDate(this.logViewDate.getDate() + 1);
                this.getLogsForDate(this.logViewDate);
            },
            async searchDateRange() {
                if (!this.searchStartDate || !this.searchEndDate) return;
                this.isLogsLoading = true;
                this.logViewTitle = `Logs from ${this.searchStartDate} to ${this.searchEndDate}`;
                this.logs = await dataLayer.fetchLogsByDateRange(this.searchStartDate, this.searchEndDate);
                this.isLogsLoading = false;
            },
            
            // Content View Methods
            async loadContent() {
                this.isContentLoading = true;
                this.content = await dataLayer.fetchContentLibrary();
                this.isContentLoading = false;
                this.$nextTick(() => feather.replace());
            },
           
            // Repertoire View Methods
            async loadRepertoire() {
                this.isRepertoireLoading = true;
                this.repertoire = await dataLayer.fetchRepertoire();
                this.isRepertoireLoading = false;
                this.$nextTick(() => feather.replace());
            },
      
            sortRepertoireBy(key) {
                if (this.repertoireSortKey === key) {
                    this.repertoireSortDirection = this.repertoireSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.repertoireSortKey = key;
                    // Default to asc for text, desc for dates/numbers
                    this.repertoireSortDirection = (key === 'title' || key === 'artist') ? 'asc' : 'desc';
                }
            },

            // --- COMPUTED PROPERTIES ---
            get groupedLogs() {
                return this.logs.reduce((acc, log) => {
                    if (!log.goals || !log.goals.topics) return acc;
                    const topicTitle = log.goals.topics.title;
                    const goalDesc = `${log.goals.goal_number}: ${log.goals.description}`;
                    
                    if (!acc[topicTitle]) acc[topicTitle] = {};
                    if (!acc[topicTitle][goalDesc]) acc[topicTitle][goalDesc] = [];
                    
                    acc[topicTitle][goalDesc].push(log);
                    return acc;
                }, {});
            },

            get sortedRepertoire() {
                if (!this.repertoire) return [];
                return [...this.repertoire].sort((a, b) => {
                    const direction = this.repertoireSortDirection === 'asc' ? 1 : -1;
                    const key = this.repertoireSortKey;
                
                    // Handle nulls so they always appear at the bottom
                    if (a[key] === null || a[key] === undefined) return 1;
                    if (b[key] === null || b[key] === undefined) return -1;
                
                    const valA = a[key];
                    const valB = b[key];
                
                    // Case-insensitive sort for strings
                    if (typeof valA === 'string' && typeof valB === 'string') {
                        return valA.localeCompare(valB, undefined, { sensitivity: 'base' }) * direction;
                    }
                
                    // Standard comparison for numbers/dates
                    if (valA < valB) return -1 * direction; 
                    if (valA> valB) return 1 * direction;
                        return 0;
                    });
                }
            }"

        @user-signed-in.window="loadData()"
        @scroll.window.debounce.250ms="localStorage.setItem('scrollPosition', window.scrollY)"
        @keydown.window="
            if ($event.key === ' ' && isYouTubeModalOpen) {
                $event.preventDefault();
            }
        "
        x-effect="
            if (isDevEnvironment) document.title = '(Dev) The Wood Shed';
            if (activeView === 'content' && content.length === 0) loadContent();
            if (activeView === 'repertoire' && repertoire.length === 0) loadRepertoire();
            
            if (activeView === 'logs' && !logsLoaded) {
                getLogsForDate(logViewDate);
                logsLoaded = true; // Mark as loaded so this only runs once per session
            }
        
            if (activeView === 'repertoire' && (repertoire.length === 0 || isRepertoireStale)) {
                loadRepertoire();
                isRepertoireStale = false;
            }
        "
        @click="
            const link = $event.target.closest('.youtube-link');
            if (link) {
                $event.preventDefault();
                const videoId = link.dataset.videoId;
                if (videoId) {
                    youTubeVideoId = videoId;
                isYouTubeModalOpen = true;
                }
            }
        "
    >
        <div class="app-header">
            <h1 id="app-title">
                The Wood Shed
                <span x-show="isDevEnvironment" style="font-weight: 500; color: #a0aec0;">(Dev)</span>
            </h1>
            <button id="sign-out-btn" @click="supabaseClient.auth.signOut()">Sign Out</button>
        </div>
        
        <div class="tabs">
            <button class="tab-btn" :class="{ 'active': activeView === 'plan' }" @click="activeView = 'plan'">Plan</button>
            <button class="tab-btn" :class="{ 'active': activeView === 'logs' }" @click="activeView = 'logs'">Logs</button>
            <button class="tab-btn" :class="{ 'active': activeView === 'content' }" @click="activeView = 'content'">Content</button>
            <button class="tab-btn" :class="{ 'active': activeView === 'repertoire' }" @click="activeView = 'repertoire'">Repertoire</button>
        </div>

        <div id="plan-view" x-show="activeView === 'plan'">
           <div class="main-controls">
                <button id="add-topic-btn" @click="isNewTopicModalOpen = true" class="btn-new">New Topic</button>
                <button @click="expandAll()">Expand All</button>
                <button @click="collapseAll()">Collapse All</button>
            </div>

            <div x-show="isLoading" style="text-align: center; padding: 2rem;">Loading your plan...</div>
            
            <div x-show="!isLoading">
                <template x-for="topic in topics" :key="topic.id">
                    <details class="topic-details" :open="uiState.topicStates[topic.id] ?? true" @toggle="uiState.topicStates[topic.id] = $event.target.open">
                        <summary class="summary-flex">
                            <h2>
                                Topic <span x-text="topic.topic_number"></span>: 
                                <span x-text="topic.title"></span>
                            </h2>
                            <button 
                                class="edit-btn" 
                                @click.prevent="isEditTopicModalOpen = true; editingTopic = topic"
                            >
                                <i data-feather="edit-2"></i>
                            </button> 
                        </summary>
                        
                        <div>
                            <div class="topic-content">
                                <template x-for="goal in topic.goals.filter(g => !g.is_complete)" :key="goal.id">
                                    <details class="goal-details" :open="uiState.goalStates[goal.id] ?? false" @toggle="uiState.goalStates[goal.id] = $event.target.open">
                                        <summary class="summary-flex">
                                            <span class="goal-text">
                                                <strong><span x-text="goal.goal_number"></span>:</strong>
                                                <span x-text="goal.description"></span>
                                            </span>
                                            <div 
                                                class="popover-container" 
                                                x-data="{ isOpen: false, searchTerm: '', searchResults: [] }"
                                            >
                                                <button 
                                                    class="content-link-btn has-tooltip" 
                                                    @click.prevent="isOpen = !isOpen"
                                                    :data-tooltip="goal.content?.map(c => c.title).join(', ')"
                                                    x-init="$nextTick(() => feather.replace())"
                                                >
                                                    <span x-text="goal.content?.length || 0"></span>
                                                </button>

                                                <div class="popover" x-show="isOpen" @click.outside="isOpen = false" x-cloak>
                                                    <h5>Linked Content</h5>
                                                    <ul>
                                                        <template x-for="item in goal.content" :key="item.id">
                                                            <li class="linked-item">
                                                                <span class="clickable-title" x-text="item.title" @click="
                                                                    if (item.type === 'YouTube') {
                                                                        const videoId = dataLayer.getYoutubeVideoId(item.url);
                                                                        if (videoId) {
                                                                            youTubeVideoId = videoId;
                                                                            isYouTubeModalOpen = true;
                                                                        }
                                                                    } else {
                                                                        window.open(item.url, '_blank');
                                                                    }
                                                                    isOpen = false; // This line closes the popover
"
                                                                ></span>
                                                                <button @click="
                                                                    dataLayer.unlinkContentFromGoal(goal.id, item.id);
                                                                    goal.content = goal.content.filter(c => c.id !== item.id);
                                                                ">×</button>
                                                            </li>
                                                        </template>
                                                        <template x-if="!goal.content || goal.content.length === 0">
                                                            <li class="no-results" style="padding: 0.5rem;">No content linked yet.</li>
                                                        </template>
                                                    </ul>
                                                    
                                                    <div class="popover-search">
                                                        <h5>Add Content</h5>
                                                        <input 
                                                            type="text" 
                                                            class="search-input" 
                                                            placeholder="Search library..."
                                                            x-model="searchTerm"
                                                            @input.debounce.300ms="dataLayer.searchContent(searchTerm).then(data => searchResults = data)"
                                                        >
                                                        <ul class="results-list" x-show="searchTerm.length > 1">
                                                            <template
                                                                x-for="result in searchResults.filter(r => (!goal.content || !goal.content.some(linked => linked.id === r.id)))">
                                                                <li @click="
                                                                    dataLayer.linkContentToGoal(goal.id, result.id);
                                                                    if (!goal.content) {
                                                                        goal.content = [];
                                                                    }
                                                                    goal.content.push(result);

                                                                    // Force Alpine to re-evaluate the 'open' state
                                                                    goal.isOpen = false;
                                                                    $nextTick(() => {
                                                                        goal.isOpen = true;
                                                                    });

                                                                    searchTerm = '';
                                                                    searchResults = [];
                                                                ">
                                                                    <span x-text="result.title"></span>
                                                                </li>
                                                            </template>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <template x-if="topic.title === 'Repertoire'">
                                                <div class="popover-container" x-data="{ isOpen: false, searchTerm: '', searchResults: [] }">
                                            
                                                    <template x-if="goal.repertoire">
                                                        <div class="pill">
                                                            <span x-text="goal.repertoire.title"></span>
                                                            <button @click.prevent="
                                                                    dataLayer.unlinkRepertoireFromGoal(goal.id);
                                                                    goal.repertoire = null;
                                                                ">×</button>
                                                        </div>
                                                    </template>
                                            
                                                    <template x-if="!goal.repertoire">
                                                        <button class="content-link-btn" @click.prevent="isOpen = !isOpen">
                                                            Add Tune
                                                        </button>
                                                    </template>
                                            
                                                    <div class="popover" x-show="isOpen" @click.outside="isOpen = false" x-cloak>
                                                        <div class="popover-search">
                                                            <input type="text" class="search-input" placeholder="Search repertoire..." x-model="searchTerm"
                                                                @input.debounce.300ms="dataLayer.searchRepertoire(searchTerm).then(data => searchResults = data)">
                                                            <ul class="results-list" x-show="searchTerm.length > 1">
                                                                <template x-for="result in searchResults" :key="result.id">
                                                                    <li 
                                                                        @click="
                                                                            dataLayer.linkRepertoireToGoal(goal.id, result.id);
                                                                            // Update both the object and the ID on the client
                                                                            goal.repertoire = result;
                                                                            goal.repertoire_id = result.id;
                                                                            isOpen = false;
                                                                            searchTerm = '';
                                                                            searchResults = [];
                                                                        "
                                                                    >
                                                                        <span x-text="result.title"></span>
                                                                    </li>
                                                                </template>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <button class="edit-btn" @click.prevent="isEditGoalModalOpen = true; editingGoal = goal">
                                                <i data-feather="edit-2"></i>
                                            </button>
                                        </summary>

                                        <div class="add-log-container">
                                            <button 
                                                class=".btn-new" 
                                                @click="isAddLogModalOpen = true; loggingForGoal = goal"
                                            >
                                                Add Log
                                            </button>
                                        </div>

                                    <ul class="log-list">
                                        <template x-for="log in goal.logs.slice(0, goal.logsToShow)" :key="log.id">
                                            <li :class="{ 'todays-log': log.isToday }">
                                                <span class="log-date" x-text="new Date(log.date).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>:
                                                <span class="log-entry" x-html="dataLayer.linkify(log.entry)"></span>
                                            
                                                <div class="popover-container" x-data="{ isOpen: false, searchTerm: '', searchResults: [] }">
                                                    <button class="content-link-btn has-tooltip" 
                                                        @click.prevent="isOpen = !isOpen"
                                                        :data-tooltip="goal.content?.map(c => c.title).join(', ')"
                                                    >
                                                        <span x-text="log.content?.length || 0"></span>
                                                    </button>
                                                
                                                    <div class="popover" x-show="isOpen" @click.outside="isOpen = false" x-cloak>
                                                        <h5>Linked Content</h5>
                                                        <ul>
                                                            <template x-for="item in log.content" :key="item.id">
                                                                <li class="linked-item">
                                                                    <span class="clickable-title" x-text="item.title" @click="
                                                                            if (item.type === 'YouTube') {
                                                                                const videoId = dataLayer.getYoutubeVideoId(item.url);
                                                                                if (videoId) {
                                                                                    youTubeVideoId = videoId;
                                                                                    isYouTubeModalOpen = true;
                                                                                }
                                                                            } else {
                                                                                window.open(item.url, '_blank');
                                                                            }
                                                                            isOpen = false;
                                                                        "></span>
                                                                    <button @click="
                                                                        dataLayer.unlinkContentFromLog(log.id, item.id);
                                                                        log.content = log.content.filter(c => c.id !== item.id);
                                                                    ">×</button>
                                                                </li>
                                                            </template>
                                                            <template x-if="!log.content || log.content.length === 0">
                                                                <li class="no-results" style="padding: 0.5rem;">No content linked yet.</li>
                                                            </template>
                                                        </ul>
                                                
                                                        <div class="popover-search">
                                                            <h5>Add Content</h5>
                                                            <input type="text" class="search-input" placeholder="Search library..." x-model="searchTerm"
                                                                @input.debounce.300ms="dataLayer.searchContent(searchTerm).then(data => searchResults = data)">
                                                            <ul class="results-list" x-show="searchTerm.length > 1">
                                                                <template
                                                                    x-for="result in searchResults.filter(r => !log.content || !log.content.some(linked => linked.id === r.id))">
                                                                    <li @click="
                                                                        dataLayer.linkContentToLog(log.id, result.id);
                                                                        if (!log.content) log.content = [];
                                                                        log.content.push(result);
                                                                        searchTerm = '';
                                                                        searchResults = [];
                                                                    ">
                                                                        <span x-text="result.title"></span>
                                                                    </li>
                                                                </template>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            
                                                <button class="edit-btn" @click="isEditLogModalOpen = true; editingLog = log; editingLogGoal = goal;">
                                                    <i data-feather="edit-2"></i>
                                                </button>
                                            </li>
                                        </template>
                                    </ul>
                                            <div class="log-controls">
                                                <template x-if="goal.logs.length > 5 && goal.logsToShow < goal.logs.length">
                                                    <button 
                                                        class="toggle-logs-btn" 
                                                        @click="
                                                            goal.logsToShow = goal.logs.length;
                                                            $nextTick(() => feather.replace());
                                                        ">
                                                        Show All (<span x-text="goal.logs.length"></span>)
                                                    </button>
                                                </template>
                                                <template x-if="goal.logsToShow > 5">
                                                    <button class="toggle-logs-btn" @click="goal.logsToShow = 5">
                                                        Show Less
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </details>
                                </template>                                

                                <template x-if="topic.goals.some(g => g.is_complete)">
                                    <div>
                                        <h4 @click="topic.isCompletedGoalsOpen = !topic.isCompletedGoalsOpen"
                                            style="cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem;">
                                            <span>Completed Goals</span>
                                            <span x-show="!topic.isCompletedGoalsOpen">▼</span>
                                            <span x-show="topic.isCompletedGoalsOpen" x-cloak>▲</span>
                                        </h4>
                                        <div x-show="topic.isCompletedGoalsOpen" x-cloak>
                                            <template x-for="goal in topic.goals.filter(g => g.is_complete)" :key="goal.id">
                                                <div class="goal-details completed-goal" :open="uiState.goalStates[goal.id] ?? false" @toggle="uiState.goalStates[goal.id] = $event.target.open" style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                                                    <span class="goal-text">
                                                        <strong><span x-text="goal.goal_number"></span>:</strong>
                                                        <span x-text="goal.description"></span>
                                                        <em>(Completed: <span
                                                                x-text="new Date(goal.date_completed).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>)</em>
                                                    </span>
                                                    <button class="edit-btn" @click.prevent="isEditGoalModalOpen = true; editingGoal = goal">
                                                        <i data-feather="edit-2"></i>
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>                       
                        </div>

                        <form 
                            class="add-goal-form" 
                            x-data="{ newGoalDescription: '' }"
                            @submit.prevent="
                                const newGoal = await dataLayer.addGoal(topic, newGoalDescription);
                                if (newGoal) {
                                    newGoal.content = [];
                                    newGoal.logs = [];
                                    newGoal.isOpen = true;
                                    topic.goals.push(newGoal);

                                    // Re-sort the array to place the new goal at the top
                                    topic.goals.sort((a, b) => {
                                        const aParts = a.goal_number.split('.').map(Number);
                                        const bParts = b.goal_number.split('.').map(Number);
                                        return bParts[1] - aParts[1];
                                    });

                                    $nextTick(() => feather.replace());
                                    newGoalDescription = '';
                                }
                            "
                        >
                            <input type="text" x-model="newGoalDescription" class="goal-input" placeholder="New goal description..." required>
                            <button type="submit">Add Goal</button>
                        </form>

                    </details>
                </template>
            </div>
        </div>

        <div id="logs-view" x-show="activeView === 'logs'">
            <div class="log-view-header">
                <div class="date-nav">
                    <button @click="prevDay()">&lt;</button>
                    <h2 x-text="logViewTitle"></h2>
                    <button @click="nextDay()">&gt;</button>
                </div>
                <div class="date-range-search">
                    <input type="date" x-model="searchStartDate">
                    <span>to</span>
                    <input type="date" x-model="searchEndDate">
                    <button @click="searchDateRange()">Search</button>
                </div>
            </div>
            
            <div id="log-view-content">
                <div x-show="isLogsLoading" style="text-align: center; padding: 2rem;">Loading logs...</div>
                
                <div x-show="!isLogsLoading">
                    <template x-if="Object.keys(groupedLogs).length === 0">
                        <p>No practice logged for this period.</p>
                    </template>

                    <template x-for="(goals, topicTitle) in groupedLogs" :key="topicTitle">
                        <div>
                            <h2 x-text="topicTitle"></h2>
                            <template x-for="(logEntries, goalDescription) in goals" :key="goalDescription">
                                <div>
                                    <h4 x-text="goalDescription"></h4>
                                    <ul class="log-list-flat">
                                        <template x-for="log in logEntries" :key="log.id">
                                            <li x-html="dataLayer.linkify(log.entry)"></li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div id="content-view" x-show="activeView === 'content'">
            <div class="main-controls">
                <button class="btn-new" @click="editingContent = { title: '', url: '', type: 'YouTube' }; isContentModalOpen = true;">
                    New Content
                </button>
            </div>

            <div x-show="isContentLoading" style="text-align: center; padding: 2rem;">Loading Content Library...</div>

            <div x-show="!isContentLoading">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>URL</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in content" :key="item.id">
                            <tr>
                                <td x-text="item.title"></td>
                                <td>
                                    <template x-if="item.type === 'YouTube'">
                                        <button class="link-button" @click="
                                            const videoId = dataLayer.getYoutubeVideoId(item.url);
                                            if (videoId) {
                                                youTubeVideoId = videoId;
                                                isYouTubeModalOpen = true;
                                            }
                                        ">
                                            <span x-text="item.url"></span>
                                        </button>
                                    </template>
                                    <template x-if="item.type !== 'YouTube'">
                                        <a :href="item.url" target="_blank" x-text="item.url"></a>
                                    </template>
                                </td>
                                <td x-text="item.type"></td>
                                <td>
                                    <button class="edit-btn" @click="editingContent = { ...item }; isContentModalOpen = true;">
                                        <i data-feather="edit-2"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="repertoire-view" x-show="activeView === 'repertoire'">
            <div class="main-controls">
                <button class="btn-new" @click="editingRepertoire = { title: '', artist: '' }; isRepertoireModalOpen = true;">
                    New Tune
                </button>
            </div>
            <div x-show="isRepertoireLoading" style="text-align: center; padding: 2rem;">Loading Repertoire...</div>
            <div x-show="!isRepertoireLoading">
                <table>
                    <thead>
                        <tr>
                            <th @click="sortRepertoireBy('title')" class="sortable">Title</th>
                            <th>Artist</th>
                            <th @click="sortRepertoireBy('practice_count')" class="sortable">Practice Count</th>
                            <th @click="sortRepertoireBy('last_practiced')" class="sortable">Last Practiced</th>
                            <th @click="sortRepertoireBy('progress')" class="sortable">Progress</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="tune in sortedRepertoire" :key="tune.id">
                            <tr>
                                <td x-text="tune.title"></td>
                                <td x-text="tune.artist"></td>
                                <td x-text="tune.practice_count"></td>
                                <td
                                    x-text="tune.last_practiced ? new Date(tune.last_practiced + 'T00:00:00').toLocaleDateString('en-US') : 'Never'">
                                </td>
                                <td>
                                    <select class="progress-select" x-model="tune.progress"
                                        @change="dataLayer.updateRepertoireProgress(tune.id, $event.target.value)">
                                        <option>1 - Backlog</option>
                                        <option>2 - Listening</option>
                                        <option>3 - Started</option>
                                        <option>4 - Memorized</option>
                                        <option>5 - Gig Ready</option>
                                        <option>6 - Off Book</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="edit-btn" @click="editingRepertoire = { ...tune }; isRepertoireModalOpen = true;">
                                        <i data-feather="edit-2"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isNewTopicModalOpen" 
            x-cloak 
            @keydown.escape.window="isNewTopicModalOpen = false"
        >
            <div class="modal-content" @click.outside="isNewTopicModalOpen = false">
                <h3>Add New Topic</h3>
                <textarea 
                    x-model="newTopicTitle" 
                    placeholder="Enter title for the new topic..."
                ></textarea>
                <div class="modal-actions">
                    <div></div> <div class="right-actions">
                        <button @click="isNewTopicModalOpen = false; newTopicTitle = ''">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                const newTopic = await dataLayer.addTopic(newTopicTitle);
                                if (newTopic) {
                                    newTopic.goals = []; 
                                    newTopic.isOpen = true;
                                    topics.push(newTopic); 
                                    $nextTick(() => feather.replace());
                                }
                                isNewTopicModalOpen = false; 
                                newTopicTitle = '';
                            "
                        >Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isEditTopicModalOpen" 
            x-cloak 
            @keydown.escape.window="isEditTopicModalOpen = false"
        >
            <div class="modal-content" @click.outside="isEditTopicModalOpen = false">
                <h3>Edit Topic</h3>
                <template x-if="editingTopic">
                    <textarea x-model="editingTopic.title"></textarea>
                </template>
                <div class="modal-actions">
                    <div>
                        <button 
                            class="btn-delete"
                            @click="
                                if (confirm('Are you sure you want to delete this topic and ALL its goals and logs?')) {
                                    dataLayer.deleteTopic(editingTopic.id);
                                    topics = topics.filter(t => t.id !== editingTopic.id);
                                    isEditTopicModalOpen = false;
                                    editingTopic = null;
                                }
                            "
                        >Delete</button>
                    </div>
                    <div class="right-actions">
                        <button @click="isEditTopicModalOpen = false; editingTopic = null">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                dataLayer.updateTopicTitle(editingTopic.id, editingTopic.title);
                                isEditTopicModalOpen = false; 
                                editingTopic = null;
                            "
                        >Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isEditGoalModalOpen" 
            x-cloak 
            @keydown.escape.window="isEditGoalModalOpen = false"
        >
            <div class="modal-content" @click.outside="isEditGoalModalOpen = false">
                <h3>Edit Goal</h3>
                <template x-if="editingGoal">
                    <textarea x-model="editingGoal.description"></textarea>
                </template>
                <div class="modal-actions">
                    <div>
                        <button 
                            class="btn-delete"
                            @click="
                                if (confirm('Are you sure you want to delete this goal and all its logs?')) {
                                    const statsUpdated = await dataLayer.deleteGoal(editingGoal);
                                    if (statsUpdated) isRepertoireStale = true;
                                    
                                    // Remove goal from local state for instant UI update
                                    const topic = topics.find(t => t.id === editingGoal.topic_id);
                                    if (topic) {
                                        topic.goals = topic.goals.filter(g => g.id !== editingGoal.id);
                                    }
                                    isEditGoalModalOpen = false;
                                    editingGoal = null;
                                }
                            "
                        >Delete</button>
                        <button
                            x-text="editingGoal?.is_complete ? 'Re-open Goal' : 'Complete Goal'"
                            @click="
                                const updatedGoal = await dataLayer.toggleGoalComplete(editingGoal);
                                if (updatedGoal) {
                                    // Find and update the goal in the local state
                                    const topic = topics.find(t => t.id === updatedGoal.topic_id);
                                    if (topic) {
                                        const goalIndex = topic.goals.findIndex(g => g.id === updatedGoal.id);
                                        topic.goals[goalIndex] = updatedGoal;
                                        $nextTick(() => feather.replace());
                                    }
                                }
                                isEditGoalModalOpen = false;
                                editingGoal = null;
                            "
                        >Complete Goal</button>
                    </div>
                    <div class="right-actions">
                        <button @click="isEditGoalModalOpen = false; editingGoal = null">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                dataLayer.updateGoal(editingGoal.id, editingGoal.description);
                                isEditGoalModalOpen = false; 
                                editingGoal = null;
                            "
                        >Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" x-show="isAddLogModalOpen" x-cloak @keydown.escape.window="isAddLogModalOpen = false">
            <div class="modal-content" @click.outside="isAddLogModalOpen = false" x-data="{ newLogEntry: '' }"
                x-init="$watch('isAddLogModalOpen', open => { if (!open) { newLogEntry = ''; } })">
                <h3 x-show="loggingForGoal">Add Log for Goal: <span x-text="loggingForGoal?.goal_number"></span></h3>

                <textarea x-model="newLogEntry" placeholder="New log entry..."></textarea>

                <div class="modal-actions">
                    <div></div>
                    <div class="right-actions">
                        <button @click="isAddLogModalOpen = false">Cancel</button>
                        <button
                            class="btn-save" 
                            @click="
                                if (newLogEntry.trim()) {
                                    const { newLog, statsUpdated } = await dataLayer.addLog(loggingForGoal, newLogEntry);
                                    if (statsUpdated) isRepertoireStale = true;
                                    if (newLog) {
                                        newLog.content = [];
                                        newLog.isToday = true;
                                        loggingForGoal.logs.unshift(newLog);
                                        $nextTick(() => feather.replace());
                                    }
                                }
                                isAddLogModalOpen = false;
                            "
                        >Save Log</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isEditLogModalOpen" 
            x-cloak 
            @keydown.escape.window="isEditLogModalOpen = false"
        >
            <div class="modal-content" @click.outside="isEditLogModalOpen = false">
                <h3>Edit Log</h3>
                <template x-if="editingLog">
                    <textarea x-model="editingLog.entry"></textarea>
                </template>
                <div class="modal-actions">
                    <div>
                        <button 
                            class="btn-delete"
                            @click="
                                if (confirm('Are you sure you want to delete this log entry?')) {
                                    const statsUpdated = await dataLayer.deleteLog(editingLog, editingLogGoal);
                                    if (statsUpdated) isRepertoireStale = true;
                                    if (editingLogGoal) {
                                        editingLogGoal.logs = editingLogGoal.logs.filter(l => l.id !== editingLog.id);
                                    }
                                    isEditLogModalOpen = false;
                                }
                            "
                        >Delete</button>
                    </div>
                    <div class="right-actions">
                        <button @click="isEditLogModalOpen = false">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                dataLayer.updateLog(editingLog.id, editingLog.entry);
                                isEditLogModalOpen = false; 
                            "
                        >Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    
        <div 
            class="modal-overlay" 
            x-show="isContentModalOpen" 
            x-cloak 
            @keydown.escape.window="isContentModalOpen = false"
        >
            <div class="modal-content" @click.outside="isContentModalOpen = false">
                <h3 x-text="editingContent?.id ? 'Edit Content' : 'Add New Content'"></h3>
                
                <template x-if="editingContent">
                    <div class="create-content-panel">
                        <input type="text" x-model="editingContent.title" placeholder="Title">
                        <input type="url" x-model="editingContent.url" placeholder="https://...">
                        <select x-model="editingContent.type">
                            <option>YouTube</option>
                            <option>Article</option>
                            <option>Image</option>
                            <option>PDF</option>
                        </select>
                    </div>
                </template>

                <div class="modal-actions">
                    <div>
                        <button 
                            class="btn-delete"
                            x-show="editingContent?.id"
                            @click="
                                if (confirm('Are you sure? This will also remove links from any logs.')) {
                                    dataLayer.deleteContent(editingContent.id);
                                    content = content.filter(c => c.id !== editingContent.id);
                                    isContentModalOpen = false;
                                }
                            "
                        >Delete</button>
                    </div>
                    <div class="right-actions">
                        <button @click="isContentModalOpen = false; editingContent = null">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                if (editingContent.id) {
                                    // Update existing content
                                    const updated = await dataLayer.updateContent(editingContent.id, editingContent.title, editingContent.url, editingContent.type);
                                    if (updated) {
                                        const index = content.findIndex(c => c.id === updated.id);
                                        content[index] = updated;
                                        isContentModalOpen = false; // Close modal on success
                                    }
                                } else {
                                    // Create new content
                                    const newContent = await dataLayer.createContent(editingContent.title, editingContent.url, editingContent.type);
                                    if (newContent) {
                                        content.unshift(newContent);
                                        $nextTick(() => feather.replace());
                                        isContentModalOpen = false; // Close modal on success
                                    } else {
                                        // Handle the error if newContent is null
                                        alert('Error: A content item with this URL already exists.');
                                    }
                                }
                            "
                        >Save</button>
                    </div>
                </div>
            </div>
        </div>
   
        <div class="modal-overlay" x-show="isRepertoireModalOpen" x-cloak
            @keydown.escape.window="isRepertoireModalOpen = false">
            <div class="modal-content" @click.outside="isRepertoireModalOpen = false">
                <h3 x-text="editingRepertoire?.id ? 'Edit Tune' : 'New Tune'"></h3>
        
                <template x-if="editingRepertoire">
                    <div class="create-content-panel">
                        <input type="text" x-model="editingRepertoire.title" placeholder="Title">
                        <input type="text" x-model="editingRepertoire.artist" placeholder="Artist">
                    </div>
                </template>
        
                <div class="modal-actions">
                    <div>
                        <button class="btn-delete" x-show="editingRepertoire?.id" @click="
                                if (confirm('Are you sure you want to delete this tune?')) {
                                    await dataLayer.deleteRepertoire(editingRepertoire.id);
                                    await loadRepertoire(); // Re-fetch the list from the database
                                isRepertoireModalOpen = false;
    }
                            ">Delete</button>
                    </div>
                    <div class="right-actions">
                        <button @click="isRepertoireModalOpen = false; editingRepertoire = null">Cancel</button>
                        <button class="btn-save" @click="
                                if (editingRepertoire.id) {
                                    // Update existing tune
                                    const updated = await dataLayer.updateRepertoire(editingRepertoire.id, editingRepertoire.title, editingRepertoire.artist);
                                    if (updated) {
                                        const index = repertoire.findIndex(r => r.id === updated.id);
                                        repertoire[index] = updated;
                                    }
                                } else {
                                    // Create new tune
                                    const newTune = await dataLayer.createRepertoire(editingRepertoire.title, editingRepertoire.artist);
                                    if (newTune) {
                                        repertoire.unshift(newTune);
                                        $nextTick(() => feather.replace());
                                    }
                                }
                                isRepertoireModalOpen = false;
                            ">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isYouTubeModalOpen" 
            x-cloak 
            @keydown.escape.window="isYouTubeModalOpen = false"
        >
            <div class="modal-content youtube-modal-content" @click.outside="isYouTubeModalOpen = false">
                <button @click="isYouTubeModalOpen = false" class="modal-close-btn">&times;</button>
                <div id="youtube-player-container">
                    <iframe
                        x-show="isYouTubeModalOpen"
                        :src="isYouTubeModalOpen ? `https://www.youtube.com/embed/${youTubeVideoId}` : ''"
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div> 
            </div>
        </div>
    </div>
</body>
</html>