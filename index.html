<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wood Shed</title>

    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="app.js" defer></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div id="auth-container" class="container">
        <h1>The Wood Shed</h1>
        <form id="auth-form">
            <input type="email" id="auth-email" placeholder="Email" required>
            <input type="password" id="auth-password" placeholder="Password" required>
            <div class="auth-actions">
                <button type="submit" id="sign-in-btn">Sign In</button>
                <button type="button" id="sign-up-btn">Sign Up</button>
            </div>
        </form>
        <p id="auth-error" class="error-message hidden"></p>
    </div>

    <div 
        class="container hidden" 
        id="app-container"
        x-data="{ 
            currentUser: null,
            topics: [],
            isLoading: true,
            activeView: 'plan',
            isDevEnvironment: (window.location.hostname === 'localhost' || window.location.protocol === 'file:'),
            isNewTopicModalOpen: false,
            newTopicTitle: '',
            isEditTopicModalOpen: false,
            editingTopic: null,
            isEditGoalModalOpen: false,
            editingGoal: null,
            async loadData() {
                this.isLoading = true;
                this.topics = await dataLayer.fetchPlanData();
                this.isLoading = false;
                this.$nextTick(() => feather.replace());
            },
            expandAll() {
                this.topics.forEach(topic => {
                    topic.isOpen = true;
                    if (topic.goals) {
                        topic.goals.forEach(goal => goal.isOpen = true);
                    }
                });
            },
            collapseAll() {
                this.topics.forEach(topic => {
                    topic.isOpen = false;
                    if (topic.goals) {
                        topic.goals.forEach(goal => goal.isOpen = false);
                    }
                });
            }    
        }"
        @user-signed-in.window="loadData()"
        x-effect="if (isDevEnvironment) document.title = '(Dev) The Wood Shed'"
    >
        <div class="app-header">
            <h1 id="app-title">
                The Wood Shed
                <span x-show="isDevEnvironment" style="font-weight: 500; color: #a0aec0;">(Dev)</span>
            </h1>
            <button id="sign-out-btn" @click="supabaseClient.auth.signOut()">Sign Out</button>
        </div>
        
        <div class="tabs">
            <button class="tab-btn" :class="{ 'active': activeView === 'plan' }" @click="activeView = 'plan'">Plan</button>
            <button class="tab-btn" :class="{ 'active': activeView === 'logs' }" @click="activeView = 'logs'">Logs</button>
        </div>

        <div id="plan-view" x-show="activeView === 'plan'">
           <div class="main-controls">
                <button id="add-topic-btn" @click="isNewTopicModalOpen = true" class="btn-new">New Topic</button>
                <button @click="expandAll()">Expand All</button>
                <button @click="collapseAll()">Collapse All</button>
            </div>

            <div x-show="isLoading" style="text-align: center; padding: 2rem;">Loading your plan...</div>
            
            <div x-show="!isLoading">
                <template x-for="topic in topics" :key="topic.id">
                    <details class="topic-details" :open="topic.isOpen" @toggle="topic.isOpen = $event.target.open">
                        <summary class="summary-flex">
                            <h2>
                                Topic <span x-text="topic.topic_number"></span>: 
                                <span x-text="topic.title"></span>
                            </h2>
                            <button 
                                class="edit-btn" 
                                @click.prevent="isEditTopicModalOpen = true; editingTopic = topic"
                            >
                                <i data-feather="edit-2"></i>
                            </button> 
                        </summary>
                        
                        <div>
                            <div class="topic-content">
                                <template x-for="goal in topic.goals.filter(g => !g.is_complete)" :key="goal.id">
                                    <details class="goal-details" :open="goal.isOpen" @toggle="goal.isOpen = $event.target.open">
                                        <summary class="summary-flex">
                                            <span class="goal-text">
                                                <strong><span x-text="goal.goal_number"></span>:</strong>
                                                <span x-text="goal.description"></span>
                                            </span>
                                            <button class="edit-btn" @click.prevent="isEditGoalModalOpen = true; editingGoal = goal">
                                                <i data-feather="edit-2"></i>
                                            </button>
                                        </summary>
                                        <div>
                                            <ul class="log-list">
                                                <template x-for="log in goal.logs" :key="log.id">
                                                    <li>
                                                        <span class="log-date" x-text="new Date(log.date).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>:
                                                        <span class="log-entry" x-html="dataLayer.linkify(log.entry)"></span>
                                                    </li>
                                                </template>
                                            </ul>
                                        </div>
                                    </details>
                                </template>

                                <template x-if="topic.goals.some(g => g.is_complete)">
                                    <div>
                                        <h4>Completed Goals</h4>
                                        <template x-for="goal in topic.goals.filter(g => g.is_complete)" :key="goal.id">
                                            <details class="goal-details completed-goal" :open="goal.isOpen" @toggle="goal.isOpen = $event.target.open">
                                                <summary class="summary-flex">
                                                    <span class="goal-text">
                                                        <strong><span x-text="goal.goal_number"></span>:</strong>
                                                        <span x-text="goal.description"></span>
                                                        <em>(Completed: <span x-text="new Date(goal.date_completed).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>)</em>
                                                    </span>
                                                    <button class="edit-btn" @click.prevent="isEditGoalModalOpen = true; editingGoal = goal">
                                                        <i data-feather="edit-2"></i>
                                                    </button>    
                                                </summary>
                                                <div>
                                                <ul class="log-list">
                                                    <template x-for="log in goal.logs" :key="log.id">
                                                        <li>
                                                            <span class="log-date" x-text="new Date(log.date).toLocaleDateString('en-US', { timeZone: 'UTC' })"></span>:
                                                            <span class="log-entry" x-html="dataLayer.linkify(log.entry)"></span>
                                                        </li>
                                                    </template>
                                                </ul>
                                            </div>
                                            </details>
                                        </template>
                                    </div>
                                </template>
                            </div>                       
                        </div>

                        <form 
                            class="add-goal-form" 
                            x-data="{ newGoalDescription: '' }"
                            @submit.prevent="
                                const newGoal = await dataLayer.addGoal(topic, newGoalDescription);
                                if (newGoal) {
                                    // Add the new goal to the topic's local array
                                    newGoal.logs = [];
                                    newGoal.isOpen = false;
                                    topic.goals.push(newGoal);
                                    $nextTick(() => feather.replace());
                                    // Reset the input field
                                    newGoalDescription = '';
                                }
                            "
                        >
                            <input type="text" x-model="newGoalDescription" class="goal-input" placeholder="New goal description..." required>
                            <button type="submit">Add Goal</button>
                        </form>

                    </details>
                </template>
            </div>
        </div>

        <div id="logs-view" x-show="activeView === 'logs'">
            <p>Logs view content will be rendered here.</p>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isNewTopicModalOpen" 
            x-cloak 
            @keydown.escape.window="isNewTopicModalOpen = false"
        >
            <div class="modal-content" @click.outside="isNewTopicModalOpen = false">
                <h3>Add New Topic</h3>
                <textarea 
                    x-model="newTopicTitle" 
                    placeholder="Enter title for the new topic..."
                ></textarea>
                <div class="modal-actions">
                    <div></div> <div class="right-actions">
                        <button @click="isNewTopicModalOpen = false; newTopicTitle = ''">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                const newTopic = await dataLayer.addTopic(newTopicTitle);
                                if (newTopic) {
                                    newTopic.goals = []; 
                                    newTopic.isOpen = true;
                                    topics.push(newTopic); 
                                    $nextTick(() => feather.replace());
                                }
                                isNewTopicModalOpen = false; 
                                newTopicTitle = '';
                            "
                        >Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isEditTopicModalOpen" 
            x-cloak 
            @keydown.escape.window="isEditTopicModalOpen = false"
        >
            <div class="modal-content" @click.outside="isEditTopicModalOpen = false">
                <h3>Edit Topic</h3>
                <template x-if="editingTopic">
                    <textarea x-model="editingTopic.title"></textarea>
                </template>
                <div class="modal-actions">
                    <div></div> <div class="right-actions">
                        <button @click="isEditTopicModalOpen = false; editingTopic = null">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                dataLayer.updateTopicTitle(editingTopic.id, editingTopic.title);
                                isEditTopicModalOpen = false; 
                                editingTopic = null;
                            "
                        >Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <div 
            class="modal-overlay" 
            x-show="isEditGoalModalOpen" 
            x-cloak 
            @keydown.escape.window="isEditGoalModalOpen = false"
        >
            <div class="modal-content" @click.outside="isEditGoalModalOpen = false">
                <h3>Edit Goal</h3>
                <template x-if="editingGoal">
                    <textarea x-model="editingGoal.description"></textarea>
                </template>
                <div class="modal-actions">
                    <div>
                        <button 
                            class="btn-delete"
                            @click="
                                if (confirm('Are you sure you want to delete this goal and all its logs?')) {
                                    dataLayer.deleteGoal(editingGoal.id);
                                    // Remove goal from local state for instant UI update
                                    const topic = topics.find(t => t.id === editingGoal.topic_id);
                                    if (topic) {
                                        topic.goals = topic.goals.filter(g => g.id !== editingGoal.id);
                                    }
                                    isEditGoalModalOpen = false;
                                    editingGoal = null;
                                }
                            "
                        >Delete</button>
                        <button
                            x-text="editingGoal?.is_complete ? 'Re-open Goal' : 'Complete Goal'"
                            @click="
                                const updatedGoal = await dataLayer.toggleGoalComplete(editingGoal);
                                if (updatedGoal) {
                                    // Find and update the goal in the local state
                                    const topic = topics.find(t => t.id === updatedGoal.topic_id);
                                    if (topic) {
                                        const goalIndex = topic.goals.findIndex(g => g.id === updatedGoal.id);
                                        topic.goals[goalIndex] = updatedGoal;
                                        $nextTick(() => feather.replace());
                                    }
                                }
                                isEditGoalModalOpen = false;
                                editingGoal = null;
                            "
                        >Complete Goal</button>
                    </div>
                    <div class="right-actions">
                        <button @click="isEditGoalModalOpen = false; editingGoal = null">Cancel</button>
                        <button 
                            class="btn-save"
                            @click="
                                dataLayer.updateGoal(editingGoal.id, editingGoal.description);
                                isEditGoalModalOpen = false; 
                                editingGoal = null;
                            "
                        >Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>
</html>